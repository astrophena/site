#!/usr/bin/env bash

set -euo pipefail
if [[ ! -L "$0" ]]; then
	cd "$(dirname $0)/.."
else
	# Symlinked. Called from a Git hook.
	GIT_HOOK="true"
	cd "$(dirname $0)/../.."
fi
source script/.shared

script/bootstrap

if [[ ! -z "${CI:-}" ]] || [[ ! -z "${GIT_HOOK:-}" ]]; then
	info "==> Linting..."
	goimports -d .
	shfmt -d .
	prettier --check --loglevel warn .
	actionlint
else
	info "==> Formatting..."
	goimports -w .
	shfmt -w .
	prettier --write --loglevel warn .
fi

info "==> Running the tests..."
staticcheck ./...
silent_run go test ./...
