name: 'Deploy'
on:
  push:
    branches: ['master']
  workflow_dispatch:
permissions:
  id-token: 'write'
  contents: 'read'
jobs:
  site:
    name: 'Site'
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Check out'
        uses: 'actions/checkout@v5'
      - name: 'Set up Go'
        uses: 'actions/setup-go@v6'
        with:
          go-version-file: 'go.mod'
      - name: 'Build'
        run: 'go tool build -prod'
      - name: 'Deploy'
        run: |
          echo "::group::Requesting OIDC token"
          OIDC_TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=astrophena.name" -H "User-Agent: actions/oidc-client" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN")
          JWT=$(echo $OIDC_TOKEN | jq -j '.value')
          echo "::endgroup::"

          echo "::group::Creating deployment archive"
          tar -czf archive.tar.gz -C build .
          echo "::endgroup::"

          echo "::group::Deploying to astrophena.name"
          curl --fail -X POST \
            -H "Authorization: Bearer $JWT" \
            -F "archive=@archive.tar.gz" \
            https://deploy.astrophena.name/site/astrophena.name
          echo "::endgroup::"
  vanity:
    name: 'Vanity'
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Check out'
        uses: 'actions/checkout@v5'
      - name: 'Set up Go'
        uses: 'actions/setup-go@v6'
        with:
          go-version-file: 'go.mod'
      - name: 'Build'
        env:
          GITHUB_TOKEN: '${{ secrets.VANITY_GITHUB_TOKEN }}'
        run: 'go tool build -prod -vanity'
      - name: 'Deploy'
        run: |
          echo "::group::Requesting OIDC token"
          OIDC_TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=astrophena.name" -H "User-Agent: actions/oidc-client" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN")
          JWT=$(echo $OIDC_TOKEN | jq -j '.value')
          echo "::endgroup::"

          echo "::group::Creating deployment archive"
          tar -czf archive.tar.gz -C build .
          echo "::endgroup::"

          echo "::group::Deploying to go.astrophena.name"
          curl --fail -X POST \
            -H "Authorization: Bearer $JWT" \
            -F "archive=@archive.tar.gz" \
            https://deploy.astrophena.name/site/go.astrophena.name
          echo "::endgroup::"
